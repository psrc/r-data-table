## ----setup, include=FALSE-----------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)
options(datatable.print.nrows = 10)
options(datatable.print.trunc.cols = TRUE)
show.results <- FALSE


## -----------------------------------------------------------------------------------------------------------------
library(data.table)
#setwd("/Users/hana/psrc/rworkshops2020/data.table")


## -----------------------------------------------------------------------------------------------------------------
d <- data.table(x = 1:10, y = letters[1:10])
d


## -----------------------------------------------------------------------------------------------------------------
df <- data.frame(x = 1:10, y = letters[1:10])
d <- as.data.table(df)
d


## -----------------------------------------------------------------------------------------------------------------
dft <- data.frame(x = 1:10, y = letters[1:10])
class(dft)
setDT(dft)
class(dft)


## -----------------------------------------------------------------------------------------------------------------
dt <- fread("ofm_april1_population_final.csv")
class(dt)


## ---- eval = FALSE------------------------------------------------------------------------------------------------
## str(dt)
## View(dt)


## ---- results = show.results--------------------------------------------------------------------------------------
dt[County == "King" & Filter < 4]


## ---- results = show.results--------------------------------------------------------------------------------------
dt[grepl("Wood", Jurisdiction)]


## ---- results = show.results--------------------------------------------------------------------------------------
dt[1:3] # is equivalent to
dt[1:3,]


## -----------------------------------------------------------------------------------------------------------------
dt4c <- dt[Filter == 4 & County %chin% c("King", "Kitsap", "Pierce", "Snohomish")] 
dim(dt4c)


## -----------------------------------------------------------------------------------------------------------------
dt4c[order(Jurisdiction)]


## -----------------------------------------------------------------------------------------------------------------
setorder(dt4c, County, Jurisdiction)


## ----  fig.cap = " ", fig.align='center', fig.show='hold', out.width="49%", echo=FALSE, eval = TRUE---------------
knitr::include_graphics(c( '../images/byvalue.png', '../images/byreference2.png'))


## -----------------------------------------------------------------------------------------------------------------
colnames(dt4c)


## -----------------------------------------------------------------------------------------------------------------
setnames(dt4c, "Jurisdiction", "City")


## -----------------------------------------------------------------------------------------------------------------
colnames(dt4c)[5:ncol(dt4c)] <- substr(colnames(dt4c)[5:ncol(dt4c)], 1, 4)
colnames(dt4c)


## -----------------------------------------------------------------------------------------------------------------
dt4c[, .(County, City)]


## -----------------------------------------------------------------------------------------------------------------
dt4c[1:10, 1:5]


## -----------------------------------------------------------------------------------------------------------------
dt4c[1:5, Filter:City]
dt4c[1:5, Filter:`2014`]


## -----------------------------------------------------------------------------------------------------------------
dt4c[1:5, list(County, City)]


## -----------------------------------------------------------------------------------------------------------------
dt4c[1:5, c("County", "City")]


## ---- results = show.results--------------------------------------------------------------------------------------
cols <- c("County", "City")
dt4c[, ..cols] # or
dt4c[, cols, with = FALSE]


## -----------------------------------------------------------------------------------------------------------------
dt4c <- dt4c[, !c("Line", "Filter")]
dim(dt4c)


## ---- results = show.results--------------------------------------------------------------------------------------
dt4c[, id := 1:nrow(dt4c)]
dt4c[, id := id + 5000]


## -----------------------------------------------------------------------------------------------------------------
d                 # d is our toy data.table
a <- d            # assign d to a
a[ , x := NULL][] # delete column in a
d                 # d changed as well!


## -----------------------------------------------------------------------------------------------------------------
d <- data.table(x = 1:10, y = letters[1:10]) # re-create d
a <- copy(d)      # use the copy() function to create a separate object
a[ , x := NULL][] # delete column in a
d                 # d is not impacted


## -----------------------------------------------------------------------------------------------------------------
dt4c[County == "King", id := id + 1000]
dt4c[1:4, .(County, City, id)]
dt4c[50:53, .(County, City, id)]


## -----------------------------------------------------------------------------------------------------------------
d[x < 5, z := TRUE][]


## -----------------------------------------------------------------------------------------------------------------
dt4c[, id := NULL]


## -----------------------------------------------------------------------------------------------------------------
d[ , ':='(u = x^2, v = x^3, z = NULL)]


## -----------------------------------------------------------------------------------------------------------------
d[, w := -4:5][w > 0, dummy := TRUE][order(x, decreasing = TRUE)]


## -----------------------------------------------------------------------------------------------------------------
d[, category := fcase(w > 0, "positive", 
                      w %between% c(-2, 0), "slightly negative",
                      w < -2, "negative")]


## -----------------------------------------------------------------------------------------------------------------
d[, dummy_new := dummy][, dummy := NULL][]


## -----------------------------------------------------------------------------------------------------------------
dt4c[, `2010` := as.numeric(`2010`)]


## -----------------------------------------------------------------------------------------------------------------
cols <- as.character(2010:2019) # column names to apply the conversion to
dt4c[, (cols) := lapply(.SD, as.numeric), .SDcols = cols] 
str(dt4c)


## -----------------------------------------------------------------------------------------------------------------
dt4c[, sum(`2019`)]
dt4c[, mean(`2019`)]


## -----------------------------------------------------------------------------------------------------------------
dt4c[, .N]


## -----------------------------------------------------------------------------------------------------------------
dt4c[, sum(`2019`), by = County]
dt4c[, .(Population = sum(`2019`)), by = County]
dt4c[, .(Population = sum(`2019`)), by = `2019` > 100000]
dt4c[, .(Population = sum(`2019`), Count = .N), by = `2019` > 100000]
dt4c[, .(Population = sum(`2019`), Count = .N), by = .(County, `2019` > 100000)]


## -----------------------------------------------------------------------------------------------------------------
dt4c[, county_sum := sum(`2019`), by = County]


## -----------------------------------------------------------------------------------------------------------------
dt4c[, county_share := round(`2019`/county_sum*100, 2)]
dt4c[, sum(county_share), by = County] 


## -----------------------------------------------------------------------------------------------------------------
dt4c[, lapply(.SD, sum), by = County, .SDcols = `2010`:`2019`]


## -----------------------------------------------------------------------------------------------------------------
counties <- fread("counties.csv")


## -----------------------------------------------------------------------------------------------------------------
dt4cm <- merge(dt4c, counties, by.x = "County", by.y = "county_name")


## -----------------------------------------------------------------------------------------------------------------
popcty <- dt4c[ , .(Pop = sum(`2019`)), by = County][, county_name := County][, County := NULL]


## -----------------------------------------------------------------------------------------------------------------
popcty[counties, , on = .(county_name)] # left join
counties[popcty, , on = .(county_name)] # right join


## -----------------------------------------------------------------------------------------------------------------
setkey(popcty, "county_name")
setkey(counties, "county_name")


## -----------------------------------------------------------------------------------------------------------------
counties[popcty]


## -----------------------------------------------------------------------------------------------------------------
counties[popcty, .(county_name, density = i.Pop/acres)]


## -----------------------------------------------------------------------------------------------------------------
counties[popcty, density := i.Pop/acres][]


## -----------------------------------------------------------------------------------------------------------------
popcty[county_name != "King"][counties]


## -----------------------------------------------------------------------------------------------------------------
popcty[county_name != "King"][counties, nomatch = NULL]


## -----------------------------------------------------------------------------------------------------------------
counties[!popcty[county_name != "King"]] 


## -----------------------------------------------------------------------------------------------------------------
head(dt4c)


## ---- results = show.results--------------------------------------------------------------------------------------
dt4c[, ':='(county_sum = NULL, county_share = NULL)]


## -----------------------------------------------------------------------------------------------------------------
dtl <- melt(dt4c, id.vars = c("County", "City"))
head(dtl)


## -----------------------------------------------------------------------------------------------------------------
dtl <- melt(dt4c, id.vars = c("County", "City"), variable.name = "Year", value.name = "Population")
head(dtl)


## -----------------------------------------------------------------------------------------------------------------
library(ggplot2)
g <- ggplot(dtl[County == "Pierce"]) + 
      geom_col(aes(x = City, y = Population, fill = as.factor(Year)),
               position = "dodge") + coord_flip() + labs(fill = "Year")
print(g)


## -----------------------------------------------------------------------------------------------------------------
dtw <- dcast(dtl, County + City ~ Year, value.var = "Population")
dtw <- dcast(dtl, ... ~ Year, value.var = "Population")
head(dtw)


## -----------------------------------------------------------------------------------------------------------------
fwrite(dtw, "my_ofm.csv")

